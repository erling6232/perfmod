import unittest
import numpy as np
from collections import namedtuple

from perfmod.fit_curves import fit_curves
from imagedata import Series
import imagedata.axis


class TestPerfusion(unittest.TestCase):

    def setUp(self):
        self.timeline = np.array(
            [0.0, 0.11808333333331879, 0.17416666666673944, 0.2302500000000388, 0.28633333333333816,
             0.34241666666663756, 0.3985000000000582, 0.4545833333333576, 0.5106666666666569, 0.5667500000000776,
             0.622833333333377, 0.6789166666666764, 0.7349999999999758, 0.791041666666691, 0.8471249999999902,
             0.903208333333411, 0.9592916666667103, 1.0153750000000097, 1.071458333333309, 1.1275416666667297,
             1.183625000000029, 1.2397083333333285, 1.295791666666749, 1.3518750000000486, 1.4079583333333479,
             1.4640416666666474, 1.520125000000068, 1.5762083333333672, 1.6322916666666667, 1.688374999999966,
             1.7444583333333867, 1.800541666666686, 1.8566249999999855, 1.912708333333406, 1.9687916666667056,
             2.0248750000000046, 2.0809583333333044, 2.137041666666725, 2.193125000000024, 2.2492083333333235,
             2.3052916666667445, 2.3613750000000437, 2.417458333333343, 2.4735416666666423, 2.5295833333333575,
             2.585666666666657, 2.6417500000000778, 2.697833333333377, 2.7539166666666763, 2.8099999999999756,
             2.8660833333333966, 2.922166666666696, 2.978249999999995, 3.0343333333334157, 3.090416666666715,
             3.1465000000000147, 3.202583333333314, 3.2586666666667345, 3.314750000000034, 3.370833333333333,
             3.426916666666633, 3.4830000000000534, 3.5390833333333527, 3.595166666666652, 3.651250000000073,
             3.7073333333333722, 3.7634166666666715, 3.819499999999971, 3.8755833333333913, 3.931666666666691]
        )
        self.aif = Series(np.array(
            [0.21924005981365743, 0.22667842490702045, 0.2382193934281661, 0.24726812622215405, 0.22836547678386568,
             0.21360377286147006, 0.21939342816609794, 0.22817376634331507, 0.3922012192784019, 0.7113991027951383,
             0.8866607875464898, 0.9616962539779916, 0.9902611096200299, 1.0, 0.9962424753652085, 0.9441739197116675,
             0.8754648978183353, 0.824584946896208, 0.8322533645182316, 0.8163030558644224, 0.8054522449292588,
             0.7903454622138723, 0.7853993328476669, 0.7968636171925924, 0.7911889881522948, 0.7725163912426671,
             0.7578697135846018, 0.7437981672481884, 0.7570645297342894, 0.7621256853648251, 0.7406924581112687,
             0.7518116636632031, 0.7406924581112687, 0.743376404278977, 0.7306084889383077, 0.7212913615275488,
             0.7057628158429509, 0.7190291783290518, 0.6893524021318201, 0.6945285840266862, 0.6802269851616118,
             0.6746290402975347, 0.6627813350715079, 0.6641999923315823, 0.6585253632912849, 0.6720601203941566,
             0.6654269391511062, 0.6573751006479813, 0.6553046278900349, 0.6438403435451096, 0.6408880027606304,
             0.6516621295195736, 0.6309190598519996, 0.644300448602431, 0.6606341781373414, 0.6290019554464936,
             0.6277750086269698, 0.6180361182469998, 0.6208350906790384, 0.6209884590314788, 0.6140868831716575,
             0.62133353782447, 0.599670258042253, 0.5950692074690388, 0.6100609639200951, 0.6046930715846784,
             0.6058049921398719, 0.5942256815306162, 0.5922702350370002, 0.5890494996357502]),
            'time'
        )
        self.tissue = Series(np.array(
            [0.004707556373520103, 0.004065326397675618, 0.004346501710483153, 0.003866160551103614,
             0.006817436277579676, 0.005808826348682949, 0.005848233494796127, 0.007329729177050982,
             0.008885778919519959, 0.014400649259358666, 0.02155251374989882, 0.02657319717631823, 0.035965943705294184,
             0.04172684244383949, 0.04956886452036177, 0.059480294296827406, 0.061242965291889793, 0.07353373464718888,
             0.08002845834984174, 0.08814207021714404, 0.08592035922276328, 0.09084944766091962, 0.08994947364833489,
             0.09270051847023589, 0.10103566240217443, 0.09464637944182439, 0.09856046760306567, 0.10235526926796434,
             0.0993699116853904, 0.10428515436950696, 0.10845805162549153, 0.1099672388158259, 0.10160120820179866,
             0.10515317664199993, 0.10020598221779159, 0.10010693182350712, 0.10097282397999395, 0.1038857576183599,
             0.09693838426440705, 0.10014527391161725, 0.09488069220249733, 0.09379539809738037, 0.09321387642771023,
             0.09411917573031026, 0.0954792548002164, 0.09180160951565422, 0.09519594937140276, 0.09360155754082365,
             0.09947535242769322, 0.09787670036510188, 0.09662738732751386, 0.10000468625521347, 0.09478164180821286,
             0.09651768635319877, 0.09961913525810613, 0.09534186231782181, 0.09343647355034954, 0.09302216598715965,
             0.09192835141801821, 0.0959585309015929, 0.09537487911591663, 0.09286986269272222, 0.08795994529862096,
             0.08477222669546583, 0.08576912098632893, 0.08667229017292281, 0.08635383783000822, 0.08591716404875409,
             0.08922629926425793, 0.08727617806065718]),
            'time'
        )
        self.tissue.axes = self.tissue.axes._replace(
            time=imagedata.axis.UniformLengthAxis('time', 0, self.tissue.shape[0])
        )
        tag_axis = imagedata.axis.VariableAxis( 'time', self.timeline)
        slice_axis = imagedata.axis.UniformLengthAxis( 'slice', 0, 1, 1)
        row_axis = imagedata.axis.UniformLengthAxis( 'row', 0, 1, 1)
        column_axis = imagedata.axis.UniformLengthAxis( 'column', 0, 1, 1)
        Axes = namedtuple('Axes', [
            'time', 'slice', 'row', 'column'
        ])
        self.tissue.axes = Axes(tag_axis, slice_axis, row_axis, column_axis)
        self.tissue.spacing = (1, 1, 1)

    def test_tofts(self):
        out = fit_curves(self.tissue, 'tofts',
                         im_aif=self.aif,
                         timeline_data=self.timeline,
                         timeline_aif=self.timeline)
        np.testing.assert_array_almost_equal(
            out['b'][:, 0],
            np.array([0.01129, 0.008336])
        )


    def test_annet(self):
        out = fit_curves(self.tissue, 'annet',
                         im_aif=self.aif,
                         timeline_data=self.timeline,
                         timeline_aif=self.timeline)
        np.testing.assert_array_almost_equal(
            out['b'][:, 0],
            np.array([-0.1125957, 0.3926565, 1.21022689e-21, 0.239271914, 2.54635224])
        )

    def test_gctt(self):
        out = fit_curves(self.tissue, 'gctt',
                         im_aif=self.aif,
                         timeline_data=self.timeline,
                         timeline_aif=self.timeline)
        np.testing.assert_array_almost_equal(
            out['b'][:, 0],
            np.array([0.007556332343697237, 0.09709963187509676, 0.001196392316879177, 0.9449136474739921,
                 0.05918557221493294, 0.05605290049976218])
        )


if __name__ == '__main__':
    unittest.main()
